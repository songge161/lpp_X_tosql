# 文件入库基本思想

## 1.源库结构

### 1 来自于表中的need,upload_files

http://111.34.80.143:8081/prod-api/admin-api/infra/file/4/get/eda03beeff55f911ddbdcd04ab16258a131090e0ff0e79347d5a7721ac7c42b2.docx



中新鲁信数智基金营业执照.pdf@ http://111.34.80.143:8081/file/caitou/defaultFile/20250723/4f8ab5f6659e8203156d958f917968e870f276aea86e38073102cce2d2c3c5c9/ 中新鲁信数智基金营业执照.pdf





### 2 来自于流程attachment

```
圣泉基金退出-2024年7月17日 第8次党委会会议纪要8号.pdf@http://111.34.80.143:8081/file/caitou/defaultFile/20250625/a85a0773aae39be3f32d0ee3dcf55872d4432ac3627d71d59b3dca531e625620/圣泉基金退出-2024年7月17日 第8次党委会会议纪要8号.pdf,圣泉基金退出凭证.pdf@http://111.34.80.143:8081/file/caitou/defaultFile/20250625/54ee9893a289e9d1e9f4d38dddf27360e4ca0749b991bb05e0eab22d16d91997/圣泉基金退出凭证.pdf,圣泉基金退出总经理办公会纪要.pdf@http://111.34.80.143:8081/file/caitou/defaultFile/20250625/6406a70f3991aa94ec1fca49754bb6eff8ea9425b8ed0a98e00a59c333f5f140/圣泉基金退出总经理办公会纪要.pdf
```

格式为  文件名@网址地址 url
Url可分割信息

文件名、时间

## 2.入库结构

### 1.写入entity的指定uuid（hdp9hlzob3）的data侧

"fjsc_upload":" ea67286d8c7a8d663f3d85e9ee4faac7b3b3108f48aee09eab8c6a0d78cb2080.gif remove_field.py"

"fjsc_label":["","ea67286d8c7a8d663f3d85e9ee4faac7b3b3108f48aee09eab8c6a0d78cb2080.gif","remove_field.py"]

"fjsc":["","i85l41g3qs","i85l4b2qnj"]

写入file表

id,uuid,name,file,doc_type,flag,size,data,path,quote,sid,eid,type,uid,create_people,create_date,update_people,update_date,del,state,filecrypt,oss,privilege

6,i85l41g3qs,ea67286d8c7a8d663f3d85e9ee4faac7b3b3108f48aee09eab8c6a0d78cb2080,../upload/files/i6qzt3nn20/202512/i85l41g3qs/i85l41g3qs,ywsp,"",6334,"{""path"":""""}","{""config"":{""cid"":null,""uid"":""root""},""eid"":""hdp9hlzob3""}","{""mod"":{""hdp9hlzob3"":[""fjsc""]}}",i6qzt3nn20,hdp9hlzob3,gif,root,hfbek06obp,1765333058,hfbek06obp,1765333058,0,0,0,0,""

7,i85l4b2qnj,remove_field,../upload/files/i6qzt3nn20/202512/i85l4b2qnj/i85l4b2qnj,ywsp,"",81704,"{""path"":""""}","{""config"":{""cid"":null,""uid"":""root""},""eid"":""hdp9hlzob3""}","{""mod"":{""hdp9hlzob3"":[""fjsc""]}}",i6qzt3nn20,hdp9hlzob3,py,root,hfbek06obp,1765333073,hfbek06obp,1765333073,0,0,0,0,""





与字段内关联

### 2.写入entity的指定uuid（hdp9hlzob3）的doc侧

直接写入file表

id,uuid,name,file,doc_type,flag,size,data,path,quote,sid,eid,type,uid,create_people,create_date,update_people,update_date,del,state,filecrypt,oss,privilege
12,i85mtk9hr8,初版流程返回json,../upload/files/i6qzt3nn20/202512/i85mtk9hr8/i85mtk9hr8,fund,9999,16649,"{""path"":null}","{""config"":{""cid"":""mahndrn6w8"",""uid"":""root""},""eid"":""hdp2j1so9x""}","",i6qzt3nn20,hdp2j1so9x,md,root,hfbek06obp,1765336605,hfbek06obp,1765337707,0,0,0,0,""


与实体关联





### 3.file表解析和config的doc解析

file表
name:文件名称（不包含后缀）

file:文件地址

doc_type:mod

size：

data:{"path":null}

path:{"config":{"cid":"mahndrn6w7","uid":"root"},"eid":"hdp2j1so9x"}

其中cid为config的uuid，uid为用户uuid,eid为entity的id

quote:{"mod":{"hdp9j1zdyr":["fjsc"]}}
映射字段

doc类型

item为详细列表

其中level为目录级别

id为目录uuid

且目录列表是按线性存储的，所以结构需要根据level顺序判断



## 3.入库策略

### 1先解析文件

将文件解析详细的基金和项目文件

### 2 制定文件映射管理

手动设置映射列表

Source_table   source_field        entity       entity_field   doc_uuid   doc_name

源表            	源字段		实体	实体字段	    目录id      文件夹名称

### 3 方案

设置一个映射管理

先将所有已经入库了的表展示出来

然后可以通过点击添加来添加映射

1.source_table （固定显示）

2.source_field（手动填写
3.entity   （固定显示）
！！！注意 entity_field  与doc_uuid，doc_name不能同时存在
4.entity_field（手动填写）：
在其data下创建如下  [entity_field]_upload,     [entity_field] _label, [entity_field]
如：

"fjsc_upload":" ea67286d8c7a8d663f3d85e9ee4faac7b3b3108f48aee09eab8c6a0d78cb2080.gif remove_field.py"
记录文件名称

"fjsc_label":["","ea67286d8c7a8d663f3d85e9ee4faac7b3b3108f48aee09eab8c6a0d78cb2080.gif","remove_field.py"]

记录文件名称

"fjsc":["","i85l41g3qs","i85l4b2qnj"]

记录文件uuid（来自于file）

同时也要为file添加quote格式为{"mod":{"hdp9hlzob3":["fjsc"]}}

hdp9hlzob3 为mod的uuid
fjsc为字段名

5.doc_uuid（手动填写） config的uuid
6.doc_name（手动填写）config下该uuid的data中item下的name
item为如下格式
"item": {
    "i7rvem8qc7": {
      "id": "i7rvem8qc7",
      "name": "适当性管理审批",
      "level": 1,
      "virtual_dir": {
        "type": "personal",
        "filter": []
      },
      "auto_archive": [],
      "privilege": []
    },"hh46cyl31k": {
      "id": "hh46cyl31k",
      "name": "总办会投资决策文件",
      "level": 2,
      "virtual_dir": {
        "type": "personal",
        "filter": []
      },
      "key": "hh46cyl31k"
    },

}

但是你只需要关注name即可，然后获取key放入到file表中path下的uid中，将uuid放入到cid中

然后整理为path的path:{"config":{"cid":"mahndrn6w7","uid":"root"},"eid":"hdp2j1so9x"}格式
但是即使没有填写doc_uuid和doc_name，也要补充为{"config":{"cid":null,"uid":"root"},"eid":"hdp9hlzob3"}



### 两类写入的例子

1.填写entity_field
写入file

id,uuid,name,file,doc_type,flag,size,data,path,quote,sid,eid,type,uid,create_people,create_date,update_people,update_date,del,state,filecrypt,oss,privilege
7,i85l4b2qnj,remove_field,../upload/files/i6qzt3nn20/202512/i85l4b2qnj/i85l4b2qnj,ywsp,"",81704,"{""path"":""""}","{""config"":{""cid"":null,""uid"":""root""},""eid"":""hdp9hlzob3""}","{""mod"":{""hdp9hlzob3"":[""fjsc""]}}",i6qzt3nn20,hdp9hlzob3,py,root,hfbek06obp,1765333073,hfbek06obp,1765333073,0,0,0,0,""

写入entity的data

2.填写doc_uuid，doc_name
写入file

id,uuid,name,file,doc_type,flag,size,data,path,quote,sid,eid,type,uid,create_people,create_date,update_people,update_date,del,state,filecrypt,oss,privilege
9,i85mejm0gt,ea67286d8c7a8d663f3d85e9ee4faac7b3b3108f48aee09eab8c6a0d78cb2080,../upload/files/i6qzt3nn20/202512/i85mejm0gt/i85mejm0gt,fund,"",6334,"{""path"":null}","{""config"":{""cid"":""mahndrn6w7"",""uid"":""h5hpa2yaz7""},""eid"":""hdp2j1so9x""}","",i6qzt3nn20,hdp2j1so9x,gif,h5hpa2yaz7,hfbek06obp,1765335739,hfbek06obp,1765335739,0,0,0,0,""



### 资源来源

入库所需文件来自于本py项目下的source/files，文件夹结构是这样的

目录内为基金文件夹，内容包括基金附件文件夹和其项目附件文件夹（如上海佳锐信息科技股份有限公司），文件夹内存着附件



你需要通过多次匹配找到文件然后按照如上要求暂时存储到本地的路径
/Users/songyihong/PEPM/lpp/upload/files中
注意解析

中新鲁信数智基金营业执照.pdf@ http://111.34.80.143:8081/file/caitou/defaultFile/20250723/4f8ab5f6659e8203156d958f917968e870f276aea86e38073102cce2d2c3c5c9/ 中新鲁信数智基金营业执照.pdf

1.支持识别,进行分割遍历解析

2.解析链接即可，链接中   中新鲁信数智基金营业执照.pdf为文件名   20250723为时间
然后进行文件存入本地的路径，以202507的文件夹下存储
如lpp/upload/files/202507/hfbek06occ/hfbek06occ.pdf这样

3.如果没有链接，则创造一个空文件即可

